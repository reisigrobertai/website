<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Robert's Astro Map</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine/astronomy.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Playfair+Display:wght@400;500;600;700&display=swap');
:root{--primary-blue:#87CEEB;--secondary-blue:#4682B4;--accent-gold:#8B6508;--deep-gold:#8B6508;--mystical-purple:#9370DB;--cosmic-dark:#0a0a1a;--panel-bg:radial-gradient(circle at 25% 0%,rgba(12,28,56,.92) 0%,rgba(5,12,28,.96) 70%);--button-gradient:linear-gradient(135deg,#5a8cc7 0%,#8f6fe8 100%)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Crimson Text',Georgia,serif;background:var(--cosmic-dark);color:#e0f4ff;overflow:hidden;touch-action:none;user-select:none;background-image:radial-gradient(circle at 20% 80%,rgba(0,100,200,.04) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(135,206,250,.04) 0%,transparent 50%),radial-gradient(1px 1px at 20px 30px,rgba(255,215,0,.3),transparent),radial-gradient(1px 1px at 40px 70px,rgba(255,215,0,.2),transparent),radial-gradient(2px 2px at 90px 40px,rgba(255,215,0,.1),transparent)}
#canvas-container{width:100vw;height:100vh;position:relative;cursor:grab}
#canvas-container:active{cursor:grabbing}
input[type="date"]::-webkit-calendar-picker-indicator,input[type="time"]::-webkit-calendar-picker-indicator{filter:invert(1);cursor:pointer}
input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
input[type="number"]{-moz-appearance:textfield}
#compass-container{position:absolute;left:50%;transform:translateX(-50%);width:200px;height:200px;pointer-events:none;transition:opacity .5s ease,bottom .3s ease;z-index:100}
@media (min-width:769px){#compass-container{bottom:30px}}
@media (max-width:768px){#compass-container{bottom:calc(45vh + 20px)}body.mobile-panel-collapsed #compass-container{bottom:80px}#compass-container{width:140px;height:140px}}
#compass{width:100%;height:100%;position:relative;filter:drop-shadow(0 12px 30px rgba(255,215,0,.2))}
.compass-outer-ring{position:absolute;width:100%;height:100%;border-radius:50%;background:conic-gradient(from 0deg,var(--accent-gold) 0deg,transparent 2deg,transparent 8deg,var(--accent-gold) 10deg,transparent 12deg,transparent 18deg,var(--accent-gold) 20deg,transparent 22deg,transparent 28deg,var(--accent-gold) 30deg,transparent 32deg,transparent 358deg,var(--accent-gold) 360deg);opacity:.4;animation:slowRotate 120s linear infinite}
.compass-base{position:absolute;inset:8px;border-radius:50%;background:var(--panel-bg);border:2px solid rgba(255,215,0,.3);box-shadow:inset 0 0 30px rgba(135,206,250,.15),0 0 0 1px rgba(255,215,0,.2),0 0 50px rgba(135,206,250,.1)}
.compass-base::before{content:'';position:absolute;inset:12px;border-radius:50%;background:radial-gradient(2px 2px at 25% 35%,rgba(255,215,0,.8),transparent 3px),radial-gradient(1px 1px at 68% 62%,rgba(255,215,0,.6),transparent 2px),radial-gradient(1.5px 1.5px at 42% 78%,rgba(255,215,0,.7),transparent 2.5px),radial-gradient(1px 1px at 75% 25%,rgba(255,215,0,.5),transparent 2px),radial-gradient(2px 2px at 15% 65%,rgba(255,215,0,.9),transparent 3px);opacity:.6}
.compass-base::after{content:'✦';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;color:var(--accent-gold);text-shadow:0 0 15px var(--accent-gold);animation:pulse 3s ease-in-out infinite}
.compass-rotator{position:absolute;inset:0;will-change:transform}
.compass-rose{width:100%;height:100%;position:absolute;opacity:.8;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'%3E%3Cg fill='none' stroke='rgba(255,215,0,0.6)' stroke-width='1.5'%3E%3Ccircle cx='100' cy='100' r='80' stroke-dasharray='5,5'/%3E%3Cpath d='M100 25 L110 75 L100 65 L90 75 Z'/%3E%3Cpath d='M100 175 L110 125 L100 135 L90 125 Z'/%3E%3Cpath d='M25 100 L75 110 L65 100 L75 90 Z'/%3E%3Cpath d='M175 100 L125 110 L135 100 L125 90 Z'/%3E%3C/g%3E%3C/svg%3E");background-size:contain;background-repeat:no-repeat;background-position:center}
.compass-label{position:absolute;font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--accent-gold);letter-spacing:2px;text-shadow:0 0 10px var(--accent-gold),0 0 20px rgba(255,215,0,.5),0 0 30px rgba(255,215,0,.3);transform:rotate(0deg)!important}
.compass-label.n{top:18px;left:50%;transform:translateX(-50%)!important}
.compass-label.s{bottom:18px;left:50%;transform:translateX(-50%)!important}
.compass-label.e{top:50%;right:18px;transform:translateY(-50%)!important}
.compass-label.w{top:50%;left:18px;transform:translateY(-50%)!important}
.compass-pointer{position:absolute;top:-12px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-top:28px solid var(--accent-gold);filter:drop-shadow(0 0 15px var(--accent-gold))}
@keyframes slowRotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:.6;transform:translate(-50%,-50%) scale(1)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}}
#control-panel{position:fixed;top:20px;left:20px;background:var(--panel-bg);padding:0;border-radius:20px;border:2px solid rgba(255,215,0,.3);width:400px;max-width:calc(100vw - 40px);max-height:calc(100vh - 40px);backdrop-filter:blur(25px);-webkit-backdrop-filter:blur(25px);z-index:1000;transition:all .5s cubic-bezier(.4,0,.2,1);box-shadow:0 20px 60px rgba(10,30,70,.5),0 0 0 1px rgba(255,215,0,.1),0 0 100px rgba(135,206,250,.15);overflow:hidden}
#info-display{position:fixed;bottom:20px;right:20px;background:var(--panel-bg);padding:20px 24px;border-radius:18px;font-size:13px;backdrop-filter:blur(25px);-webkit-backdrop-filter:blur(25px);border:2px solid rgba(255,215,0,.3);box-shadow:0 12px 40px rgba(10,30,70,.4),0 0 80px rgba(135,206,250,.2);transition:all .5s cubic-bezier(.4,0,.2,1);z-index:999}
@media (max-width:768px){#control-panel{position:fixed;top:auto;bottom:0;left:0;right:0;width:100vw;max-width:none;height:45vh;max-height:45vh;border-radius:20px 20px 0 0;border-bottom:none;transform:translateY(0);transition:transform .3s ease}#control-panel.mobile-collapsed{transform:translateY(calc(100% - 60px))}#info-display{display:none}.mobile-info{display:block;margin-top:24px;padding:20px;background:rgba(6,16,36,.6);border-radius:16px;border:2px solid rgba(255,215,0,.2)}.desktop-info{display:none}.mobile-handle{display:block;position:absolute;top:8px;left:50%;transform:translateX(-50%);width:40px;height:4px;background:rgba(255,215,0,.5);border-radius:2px;cursor:pointer}}
@media (min-width:769px){.mobile-handle{display:none}.mobile-info{display:none}.desktop-info{display:block}}
#control-panel.collapsed{width:auto;height:auto;padding:0;background:transparent;border-color:transparent;box-shadow:none;backdrop-filter:none;-webkit-backdrop-filter:none}
#control-panel.collapsed .panel-content{display:none}
#control-panel.collapsed .toggle-panel{display:none}
#control-panel.collapsed .panel-header{padding:15px 20px;background:var(--panel-bg);border:2px solid rgba(255,215,0,.3);border-radius:20px;box-shadow:0 8px 30px rgba(10,30,70,.35);backdrop-filter:blur(25px);-webkit-backdrop-filter:blur(25px)}
.panel-header{display:flex;justify-content:space-between;align-items:center;padding:24px;border-bottom:1px solid rgba(255,215,0,.2);cursor:pointer;transition:background .3s ease}
.panel-header:hover{background:rgba(255,215,0,.05)}
.panel-header h2{font-family:'Playfair Display',serif;font-size:24px;font-weight:700;margin:0;background:linear-gradient(135deg,var(--accent-gold) 0%,var(--primary-blue) 50%,var(--mystical-purple) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-shadow:0 0 40px rgba(255,215,0,.5)}
.toggle-panel{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,rgba(255,215,0,.2) 0%,rgba(135,206,250,.2) 100%);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s ease;border:2px solid rgba(255,215,0,.3)}
.toggle-panel:hover{background:linear-gradient(135deg,rgba(255,215,0,.4) 0%,rgba(135,206,250,.4) 100%);transform:translateY(-2px);box-shadow:0 0 25px rgba(255,215,0,.4)}
.toggle-panel::before{content:'−';font-size:26px;color:var(--accent-gold);font-family:'Playfair Display',serif;text-shadow:0 0 10px var(--accent-gold)}
.panel-content{padding:24px;overflow-y:auto;max-height:calc(100vh - 140px);scrollbar-width:none;-ms-overflow-style:none}
@media (max-width:768px){.panel-content{max-height:calc(45vh - 80px)}}
.panel-content::-webkit-scrollbar{display:none}
.timezone-select select{-webkit-appearance:none;-moz-appearance:none;appearance:none;scrollbar-width:none;-ms-overflow-style:none}
.timezone-select select::-webkit-scrollbar{display:none}
.control-group{margin-bottom:24px;animation:fadeInUp .6s ease backwards}
.control-group label{display:block;margin-bottom:12px;font-size:13px;color:rgba(255,215,0,.9);text-transform:uppercase;letter-spacing:1.8px;font-weight:600;font-family:'Playfair Display',serif;text-shadow:0 0 15px rgba(255,215,0,.3)}
.control-group input[type="number"]{width:100%;padding:16px 18px;background:rgba(6,16,36,.7);border:2px solid rgba(255,215,0,.25);border-radius:14px;color:#e0f4ff;font-size:15px;font-family:'Crimson Text',serif;transition:all .3s ease}
.control-group input:focus{outline:none;background:rgba(8,24,52,.9);border-color:var(--accent-gold);box-shadow:0 0 0 4px rgba(255,215,0,.15),0 0 40px rgba(255,215,0,.2)}
.control-group input.error{border-color:rgba(255,120,120,.8);background:rgba(80,10,10,.3)}
.error-message{color:rgba(255,165,165,.95);font-size:11px;margin-top:6px;display:none}
.error-message.show{display:block}
.datetime-group{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.datetime-input{position:relative}
.datetime-input select,.datetime-input input{width:100%;padding:16px 18px;background:rgba(6,16,36,.7);border:2px solid rgba(255,215,0,.25);border-radius:14px;color:#e0f4ff;font-size:14px;font-family:'Crimson Text',serif;transition:all .3s ease;cursor:pointer}
.datetime-input select:focus,.datetime-input input:focus{outline:none;background:rgba(8,24,52,.9);border-color:var(--accent-gold);box-shadow:0 0 0 4px rgba(255,215,0,.15),0 0 40px rgba(255,215,0,.2)}
.datetime-input select option{background:#03132c;color:#e0f4ff}
.timezone-select{grid-column:span 2;margin-top:10px}
@media (max-width:768px){.datetime-group{grid-template-columns:1fr}}
.range-container{position:relative;margin-top:12px}
.range-track{width:100%;height:8px;background:linear-gradient(90deg,rgba(6,16,36,.8),rgba(12,24,48,.8));border-radius:4px;position:relative;overflow:hidden;border:1px solid rgba(255,215,0,.2);box-shadow:inset 0 2px 4px rgba(0,0,0,.3)}
.range-fill{height:100%;background:linear-gradient(90deg,var(--accent-gold) 0%,var(--primary-blue) 50%,var(--mystical-purple) 100%);border-radius:4px;transition:width .2s ease;box-shadow:0 0 20px rgba(255,215,0,.4);position:relative}
.range-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg,transparent 30%,rgba(255,255,255,.2) 50%,transparent 70%);animation:shimmer 2s ease-in-out infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
input[type="range"]{width:100%;height:8px;background:transparent;outline:none;position:absolute;top:0;left:0;cursor:pointer;-webkit-appearance:none;appearance:none}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:22px;height:22px;background:radial-gradient(circle,#fff 0%,var(--accent-gold) 100%);border-radius:50%;cursor:pointer;border:3px solid var(--accent-gold);box-shadow:0 4px 15px rgba(255,215,0,.6),0 0 0 2px rgba(255,255,255,.1),0 0 25px rgba(255,215,0,.4);transition:all .2s ease}
input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.2);box-shadow:0 6px 20px rgba(255,215,0,.8),0 0 0 3px rgba(255,255,255,.2),0 0 30px rgba(255,215,0,.6)}
input[type="range"]::-moz-range-thumb{width:22px;height:22px;background:radial-gradient(circle,#fff 0%,var(--accent-gold) 100%);border-radius:50%;cursor:pointer;border:3px solid var(--accent-gold);box-shadow:0 4px 15px rgba(255,215,0,.6)}
.range-value{display:inline-block;margin-left:14px;font-size:14px;color:var(--accent-gold);font-weight:700;min-width:55px;text-align:right;font-family:'Playfair Display',serif;text-shadow:0 0 10px rgba(255,215,0,.5)}
button{width:100%;padding:18px;background:var(--button-gradient)!important;border:2px solid var(--accent-gold)!important;border-radius:16px;color:#fff!important;font-weight:700;font-size:16px;font-family:'Playfair Display',serif;cursor:pointer;transition:transform .3s ease,box-shadow .3s ease!important;margin-top:18px;position:relative;overflow:hidden;text-transform:uppercase;letter-spacing:1.5px;box-shadow:0 8px 25px rgba(138,43,226,.3),0 0 50px rgba(70,130,180,.2),inset 0 1px 0 rgba(255,215,0,.3)!important}
button::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,215,0,.1) 0%,transparent 70%);transform:scale(0);transition:transform .6s ease}
button:hover{transform:translateY(-3px)!important;box-shadow:0 15px 40px rgba(138,43,226,.4),0 0 80px rgba(70,130,180,.3),inset 0 1px 0 rgba(255,215,0,.5)!important}
button:hover::before{transform:scale(1)}
button:active{transform:translateY(-1px)!important}
button:disabled{background:var(--button-gradient)!important;border:2px solid var(--accent-gold)!important;cursor:not-allowed!important;transform:none!important;opacity:.7!important}
.toggle-group{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding:18px;background:rgba(6,16,36,.6);border-radius:14px;border:2px solid rgba(255,215,0,.2);transition:all .3s ease}
.toggle-group:hover{background:rgba(10,24,52,.7);border-color:rgba(255,215,0,.4);box-shadow:0 0 20px rgba(255,215,0,.1)}
.toggle-group label{margin:0;font-size:15px;color:rgba(255,215,0,.9);text-transform:none;letter-spacing:.8px;font-family:'Playfair Display',serif}
.toggle-switch{position:relative;width:60px;height:32px;background:rgba(6,16,36,.9);border-radius:16px;cursor:pointer;transition:all .3s ease;border:2px solid rgba(255,215,0,.3)}
.toggle-switch.active{background:linear-gradient(135deg,var(--accent-gold) 0%,var(--primary-blue) 100%);border-color:var(--accent-gold);box-shadow:0 0 25px rgba(255,215,0,.4)}
.toggle-switch::after{content:'';position:absolute;width:26px;height:26px;background:#fff;border-radius:50%;top:2px;left:2px;transition:all .3s ease;box-shadow:0 4px 10px rgba(0,0,0,.3)}
.toggle-switch.active::after{transform:translateX(28px);background:#f6fbff;box-shadow:0 4px 15px rgba(255,215,0,.6)}
#info-display.collapsed{opacity:0;transform:translateY(20px);pointer-events:none}
#info-display div{margin:8px 0;color:rgba(255,215,0,.9);font-family:'Crimson Text',serif}
.legal-links{margin-top:12px;font-size:10px;text-align:center;color:rgba(255,215,0,.6)}
.legal-links a{color:rgba(255,215,0,.8);text-decoration:none;margin:0 8px;transition:all .3s ease;opacity:.8}
.legal-links a:hover{opacity:1;text-shadow:0 0 10px rgba(255,215,0,.5)}
.mobile-info div{margin:8px 0;color:rgba(255,215,0,.9);font-family:'Crimson Text',serif}
.mobile-info .legal-links{margin-top:12px;font-size:10px;text-align:center;color:rgba(255,215,0,.6)}
.mobile-info .legal-links a{color:rgba(255,215,0,.8);text-decoration:none;margin:0 8px;transition:all .3s ease;opacity:.8}
.mobile-info .legal-links a:hover{opacity:1;text-shadow:0 0 10px rgba(255,215,0,.5)}
#loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:20px;color:var(--accent-gold);text-align:center;font-family:'Playfair Display',serif}
.loading-spinner{width:60px;height:60px;margin:0 auto 30px;border:4px solid rgba(255,215,0,.2);border-top-color:var(--accent-gold);border-radius:50%;animation:spin 1.5s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.collapsible{background:rgba(6,16,36,.6);padding:20px;margin-top:24px;border-radius:16px;border:2px solid rgba(255,215,0,.2)}
.collapsible h3{font-size:16px;margin-bottom:18px;color:var(--accent-gold);font-weight:700;text-transform:uppercase;letter-spacing:1.4px;font-family:'Playfair Display',serif;text-shadow:0 0 15px rgba(255,215,0,.4)}
.mobile-handle{display:none}
@media (hover:none) and (pointer:coarse){.toggle-panel:hover,.toggle-group:hover,button:hover{transform:none}}
</style>
</head>
<body>
<div id="canvas-container">
<div id="loading">
<div class="loading-spinner"></div>
Loading celestial data...
</div>
</div>
<div id="compass-container">
<div id="compass">
<div class="compass-outer-ring"></div>
<div class="compass-base">
<div class="compass-rotator" id="compass-rotator">
<div class="compass-rose"></div>
<div class="compass-label n">N</div>
<div class="compass-label e">E</div>
<div class="compass-label s">S</div>
<div class="compass-label w">W</div>
</div>
</div>
<div class="compass-pointer"></div>
</div>
</div>
<div id="control-panel">
<div class="mobile-handle" onclick="toggleMobilePanel()"></div>
<div class="panel-header" onclick="togglePanel()">
<h2>Robert's Astro Map</h2>
<div class="toggle-panel"></div>
</div>
<div class="panel-content">
<div class="control-group">
<label for="latitude">Latitude</label>
<input type="number" id="latitude" min="-90" max="90" step="0.0001" value="51.198062">
<div class="error-message" id="lat-error">Latitude must be between -90 and 90</div>
</div>
<div class="control-group">
<label for="longitude">Longitude</label>
<input type="number" id="longitude" min="-180" max="180" step="0.0001" value="6.692754">
<div class="error-message" id="lon-error">Longitude must be between -180 and 180</div>
</div>
<div class="control-group">
<label>Date & Time</label>
<div class="datetime-group">
<div class="datetime-input">
<input type="date" id="date-input">
</div>
<div class="datetime-input">
<input type="time" id="time-input" step="60">
</div>
<div class="datetime-input timezone-select">
<select id="timezone-select">
<option value="UTC">Universal Time (UTC)</option>
<option value="Europe/London">London (GMT/BST)</option>
<option value="Europe/Berlin" selected>Berlin (CET/CEST)</option>
<option value="Europe/Paris">Paris (CET/CEST)</option>
<option value="Europe/Madrid">Madrid (CET/CEST)</option>
<option value="Europe/Rome">Rome (CET/CEST)</option>
<option value="Europe/Moscow">Moscow (MSK)</option>
<option value="Africa/Johannesburg">Johannesburg (SAST)</option>
<option value="Asia/Dubai">Dubai (GST)</option>
<option value="Asia/Kolkata">Kolkata (IST)</option>
<option value="Asia/Bangkok">Bangkok (ICT)</option>
<option value="Asia/Singapore">Singapore (SGT)</option>
<option value="Asia/Hong_Kong">Hong Kong (HKT)</option>
<option value="Asia/Shanghai">Shanghai (CST)</option>
<option value="Asia/Tokyo">Tokyo (JST)</option>
<option value="Australia/Sydney">Sydney (AEST/AEDT)</option>
<option value="Pacific/Auckland">Auckland (NZST/NZDT)</option>
<option value="Pacific/Honolulu">Honolulu (HST)</option>
<option value="America/Vancouver">Vancouver (PST/PDT)</option>
<option value="America/Los_Angeles">Los Angeles (PST/PDT)</option>
<option value="America/Denver">Denver (MST/MDT)</option>
<option value="America/Chicago">Chicago (CST/CDT)</option>
<option value="America/Mexico_City">Mexico City (CST/CDT)</option>
<option value="America/New_York">New York (EST/EDT)</option>
<option value="America/Sao_Paulo">São Paulo (BRT)</option>
</select>
</div>
</div>
</div>
<button id="update-button" onclick="updateSkyAndURL()">✨ Update Sky View ✨</button>
<div class="collapsible">
<h3>✨ Celestial Settings ✨</h3>
<div class="control-group">
<label for="mag-cutoff">Star Visibility<span class="range-value" id="mag-cutoff-value">10.0</span></label>
<div class="range-container">
<div class="range-track">
<div class="range-fill" id="mag-cutoff-fill"></div>
</div>
<input type="range" id="mag-cutoff" min="0" max="10" step="0.1" value="10.0" oninput="updateVisualSetting('magCutoff', this.value)">
</div>
</div>
<div class="control-group">
<label for="star-scale">Star Radiance<span class="range-value" id="star-scale-value">1.0</span></label>
<div class="range-container">
<div class="range-track">
<div class="range-fill" id="star-scale-fill"></div>
</div>
<input type="range" id="star-scale" min="0" max="10" step="0.1" value="1.0" oninput="updateVisualSetting('starScale', this.value)">
</div>
</div>
<div class="control-group">
<label for="brightness">Cosmic Brightness<span class="range-value" id="brightness-value">9.0</span></label>
<div class="range-container">
<div class="range-track">
<div class="range-fill" id="brightness-fill"></div>
</div>
<input type="range" id="brightness" min="0" max="10" step="0.1" value="9.0" oninput="updateVisualSetting('brightness', this.value)">
</div>
</div>
<div class="control-group">
<label for="glow-intensity">Stellar Aura<span class="range-value" id="glow-intensity-value">8.5</span></label>
<div class="range-container">
<div class="range-track">
<div class="range-fill" id="glow-intensity-fill"></div>
</div>
<input type="range" id="glow-intensity" min="0" max="10" step="0.1" value="8.5" oninput="updateVisualSetting('glowIntensity', this.value)">
</div>
</div>
<div class="control-group">
<label for="color-temp">Spectral Temperature<span class="range-value" id="color-temp-value">2.0</span></label>
<div class="range-container">
<div class="range-track">
<div class="range-fill" id="color-temp-fill"></div>
</div>
<input type="range" id="color-temp" min="0" max="10" step="0.1" value="2.0" oninput="updateVisualSetting('colorTemp', this.value)">
</div>
</div>
<div class="toggle-group">
<label>Stellar Scintillation</label>
<div class="toggle-switch active" id="twinkle-toggle" onclick="toggleTwinkle()"></div>
</div>
<div class="toggle-group">
<label>Celestial Compass</label>
<div class="toggle-switch active" id="compass-toggle" onclick="toggleCompass()"></div>
</div>
</div>
<div class="mobile-info">
<div id="mobile-star-count">Stars visible: 0</div>
<div id="mobile-location-info">Location: --</div>
<div id="mobile-time-info">Time: --</div>
<div class="legal-links">
<a href="#" target="_blank">Imprint</a> | <a href="#" target="_blank">Privacy Policy</a>
</div>
</div>
<button id="screenshot-button" onclick="takeScreenshot()">📸 Capture Celestial View</button>
</div>
</div>
<div id="info-display" class="desktop-info">
<div id="desktop-star-count">Stars visible: 0</div>
<div id="desktop-location-info">Location: --</div>
<div id="desktop-time-info">Time: --</div>
<div class="legal-links">
<a href="#" target="_blank">Imprint</a> | <a href="#" target="_blank">Privacy Policy</a>
</div>
</div>
<script src="stars.js"></script>
<script>
let scene,camera,renderer,controls,starsMesh;let horizonMesh,earthMesh,sunGlowMesh;let currentSettings={magCutoff:7.5,starScale:0.1,brightness:1.8,glowIntensity:0.85,colorTemp:0.4,twinkle:true,showCompass:true};let animationTime=0,touchStartDistance=0,prevAzimuth=0,compassAccumDeg=0;const keyStates={};let rotationFrame;
function initScene(){scene=new THREE.Scene;scene.background=new THREE.Color(0);camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,1e3);camera.position.set(0,0,.1);renderer=new THREE.WebGLRenderer({antialias:true,alpha:true,powerPreference:"high-performance"});renderer.setSize(window.innerWidth,window.innerHeight);renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));document.getElementById("canvas-container").appendChild(renderer.domElement);controls=new THREE.OrbitControls(camera,renderer.domElement);controls.enablePan=false;controls.enableZoom=false;controls.minDistance=.1;controls.maxDistance=.1;controls.rotateSpeed=-.4;controls.enableDamping=true;controls.dampingFactor=.05;controls.minPolarAngle=.05;controls.maxPolarAngle=Math.PI-.05;setupCustomZoom();createEarthAndHorizon();setupTouchControls();setupKeyboardControls();setupSliderListeners();prevAzimuth=controls.getAzimuthalAngle();var l=document.getElementById("loading");if(l&&l.parentNode)l.parentNode.removeChild(l)}
function setupCustomZoom(){renderer.domElement.addEventListener("wheel",onWheel,{passive:false})}
function onWheel(e){e.preventDefault();const d=e.deltaY,z=.05;camera.fov=THREE.MathUtils.clamp(camera.fov+d*z,15,120);camera.updateProjectionMatrix()}
function createEarthAndHorizon(){const eg=new THREE.SphereGeometry(99,64,32),em=new THREE.ShaderMaterial({uniforms:{time:{value:0}},vertexShader:"varying vec3 vPosition;void main(){vPosition=position;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);} ",fragmentShader:"uniform float time;varying vec3 vPosition;void main(){float height=(vPosition.y+99.0)/100.0;vec3 color1=vec3(0.0,0.02,0.08);vec3 color2=vec3(0.02,0.04,0.1);vec3 color3=vec3(0.01,0.01,0.03);vec3 color=mix(color1,color2,height);color=mix(color,color3,sin(time*0.5+vPosition.x*0.05)*0.3+0.5);float shimmer=0.02*sin(time*2.0+vPosition.x*0.1+vPosition.z*0.1);color+=shimmer;gl_FragColor=vec4(color,1.0);} ",transparent:false,depthWrite:true,depthTest:true});earthMesh=new THREE.Mesh(eg,em);earthMesh.position.y=-99.5;earthMesh.renderOrder=-1;scene.add(earthMesh);const hg=new THREE.RingGeometry(98,100,128),hm=new THREE.MeshBasicMaterial({color:4620980,side:THREE.DoubleSide,transparent:true,opacity:.4});horizonMesh=new THREE.Mesh(hg,hm);horizonMesh.rotation.x=Math.PI/2;horizonMesh.renderOrder=0;scene.add(horizonMesh);const sg=new THREE.RingGeometry(95,105,128),sm=new THREE.ShaderMaterial({uniforms:{time:{value:0}},vertexShader:"varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);} ",fragmentShader:"uniform float time;varying vec2 vUv;void main(){float dist=distance(vUv,vec2(0.5));float intensity=0.15+0.08*sin(time*0.5);float alpha=intensity*(1.0-smoothstep(0.45,0.55,dist));vec3 color=mix(vec3(0.5,0.7,1.0),vec3(0.8,0.6,1.0),sin(time*0.3)*0.5+0.5);gl_FragColor=vec4(color,alpha);} ",transparent:true,blending:THREE.AdditiveBlending,side:THREE.DoubleSide,depthWrite:false});sunGlowMesh=new THREE.Mesh(sg,sm);sunGlowMesh.rotation.x=Math.PI/2;sunGlowMesh.position.y=.1;sunGlowMesh.renderOrder=1;scene.add(sunGlowMesh)}
function setupTouchControls(){renderer.domElement.addEventListener("touchstart",onTouchStart,{passive:false});renderer.domElement.addEventListener("touchmove",onTouchMove,{passive:false})}
function setupKeyboardControls(){document.addEventListener("keydown",e=>{const tag=e.target&&e.target.tagName?e.target.tagName.toLowerCase():"";if(tag==="input"||tag==="select"||tag==="textarea")return;keyStates[e.key]=true});document.addEventListener("keyup",e=>{keyStates[e.key]=false});function loop(){let moved=false;const base=.08,rot=(keyStates["Shift"]?base*2:base)/60;if(keyStates["ArrowLeft"]){controls.rotateLeft(rot);moved=true}if(keyStates["ArrowRight"]){controls.rotateLeft(-rot);moved=true}if(keyStates["ArrowUp"]){controls.rotateUp(rot);moved=true}if(keyStates["ArrowDown"]){controls.rotateUp(-rot);moved=true}if(moved)controls.update();rotationFrame=requestAnimationFrame(loop)}loop()}
function onTouchStart(e){if(e.touches.length===2){const dx=e.touches[0].pageX-e.touches[1].pageX,dy=e.touches[0].pageY-e.touches[1].pageY;touchStartDistance=Math.sqrt(dx*dx+dy*dy)}}
function onTouchMove(e){if(e.touches.length===2){e.preventDefault();const dx=e.touches[0].pageX-e.touches[1].pageX,dy=e.touches[0].pageY-e.touches[1].pageY,dist=Math.sqrt(dx*dx+dy*dy),delta=touchStartDistance-dist,zoomSpeed=.1;camera.fov=THREE.MathUtils.clamp(camera.fov+delta*zoomSpeed,15,120);camera.updateProjectionMatrix();touchStartDistance=dist}}
function updateCompass(){if(!currentSettings.showCompass)return;const rotator=document.getElementById("compass-rotator");if(!rotator||!controls)return;const cur=controls.getAzimuthalAngle();let delta=cur-prevAzimuth;delta=THREE.MathUtils.euclideanModulo(delta+Math.PI,Math.PI*2)-Math.PI;compassAccumDeg+=-delta*(180/Math.PI);prevAzimuth=cur;rotator.style.transform=`rotate(${compassAccumDeg}deg)`}
function setupSliderListeners(){[{id:"mag-cutoff",fill:"mag-cutoff-fill",val:"mag-cutoff-value"},{id:"star-scale",fill:"star-scale-fill",val:"star-scale-value"},{id:"brightness",fill:"brightness-fill",val:"brightness-value"},{id:"glow-intensity",fill:"glow-intensity-fill",val:"glow-intensity-value"},{id:"color-temp",fill:"color-temp-fill",val:"color-temp-value"}].forEach(s=>{const slider=document.getElementById(s.id),fill=document.getElementById(s.fill),valueEl=document.getElementById(s.val),update=()=>{const percent=(slider.value-slider.min)/(slider.max-slider.min)*100;fill.style.width=percent+"%";valueEl.textContent=parseFloat(slider.value).toFixed(1)};slider.addEventListener("input",update);slider.addEventListener("change",update);update()})}
function horizontalToCartesian(alt,az,r=100){const altR=alt*Math.PI/180,azR=(90-az)*Math.PI/180,x=r*Math.cos(altR)*Math.cos(azR),y=r*Math.sin(altR),z=-r*Math.cos(altR)*Math.sin(azR);return{x,y,z}}
function bvToColor(bv,t){if(bv==null||t===0)return new THREE.Color(1,1,1);bv=Math.max(-.4,Math.min(2,bv))*t;let r,g,b;if(bv<0){r=.6+.7*bv;g=.7+.5*bv;b=1}else if(bv<.4){r=.85+.375*bv;g=.85+.125*bv;b=1-.875*bv}else if(bv<1.6){r=1;g=.9-(bv-.4)*.5;b=.8-(bv-.4)*.5}else{r=1;g=.4-(bv-1.6)*.25;b=.3-(bv-1.6)*.25}return new THREE.Color(r,g,b)}
function sliderToActual(v,s){const val=parseFloat(v);switch(s){case"magCutoff":return 1+val/10*6.5;case"starScale":return .01+val/10*.99;case"brightness":return .1+val/10*1.9;case"glowIntensity":return Math.max(.3,val/10);case"colorTemp":return val/10*2;default:return val}}
function validateInputs(){let ok=true;const lat=parseFloat(document.getElementById("latitude").value),lon=parseFloat(document.getElementById("longitude").value),latI=document.getElementById("latitude"),lonI=document.getElementById("longitude"),latE=document.getElementById("lat-error"),lonE=document.getElementById("lon-error");if(isNaN(lat)||lat<-90||lat>90){latI.classList.add("error");latE.classList.add("show");ok=false}else{latI.classList.remove("error");latE.classList.remove("show")}if(isNaN(lon)||lon<-180||lon>180){lonI.classList.add("error");lonE.classList.add("show");ok=false}else{lonI.classList.remove("error");lonE.classList.remove("show")}return ok}
function createStarField(){if(!validateInputs())return;const btn=document.getElementById("update-button");btn.disabled=true;setTimeout(()=>{if(starsMesh){scene.remove(starsMesh);starsMesh.geometry.dispose();starsMesh.material.dispose()}const lat=parseFloat(document.getElementById("latitude").value),lon=parseFloat(document.getElementById("longitude").value),dateStr=document.getElementById("date-input").value,timeStr=document.getElementById("time-input").value,tz=document.getElementById("timezone-select").value,local=moment.tz(`${dateStr} ${timeStr}`,tz),utc=local.utc().toDate(),observer=new Astronomy.Observer(lat,lon,0),positions=[],colors=[],sizes=[],twinklePhases=[];let visible=0;hipparcos_catalog.forEach(star=>{const[hip,vmag,ra_deg,dec_deg,bv]=star;if(vmag>currentSettings.magCutoff)return;try{const ra_hours=ra_deg/15,hor=Astronomy.Horizon(utc,observer,ra_hours,dec_deg,"normal");if(hor.altitude>-10){const p=horizontalToCartesian(hor.altitude,hor.azimuth);positions.push(p.x,p.y,p.z);colors.push(...bvToColor(bv,currentSettings.colorTemp).toArray());const bf=Math.max(0,currentSettings.magCutoff-vmag),sz=.5+Math.pow(bf,1.8)*currentSettings.starScale;sizes.push(sz);twinklePhases.push(Math.random()*Math.PI*2);visible++}}catch(e){}});const geom=new THREE.BufferGeometry;geom.setAttribute("position",new THREE.Float32BufferAttribute(positions,3));geom.setAttribute("color",new THREE.Float32BufferAttribute(colors,3));geom.setAttribute("size",new THREE.Float32BufferAttribute(sizes,1));geom.setAttribute("twinklePhase",new THREE.Float32BufferAttribute(twinklePhases,1));const tex=createStarTexture(currentSettings.glowIntensity),mat=new THREE.ShaderMaterial({uniforms:{pointTexture:{value:tex},brightness:{value:currentSettings.brightness},time:{value:0},twinkleEnabled:{value:currentSettings.twinkle?1:0}},vertexShader:"attribute float size;attribute float twinklePhase;varying vec3 vColor;uniform float time;uniform float twinkleEnabled;void main(){vColor=color;float twinkle=1.0;if(twinkleEnabled>0.5){twinkle=0.85+0.15*sin(time*0.8+twinklePhase);if(size<1.2){twinkle*=0.9+0.1*sin(time*1.2+twinklePhase*1.5);}}vec4 mvPosition=modelViewMatrix*vec4(position,1.0);gl_PointSize=size*twinkle*400.0/length(mvPosition.xyz);gl_Position=projectionMatrix*mvPosition;}",fragmentShader:"uniform sampler2D pointTexture;uniform float brightness;varying vec3 vColor;void main(){vec4 tex=texture2D(pointTexture,gl_PointCoord);gl_FragColor=vec4(vColor*brightness,1.0)*tex;}",blending:THREE.AdditiveBlending,depthTest:true,depthWrite:false,transparent:true,vertexColors:true});starsMesh=new THREE.Points(geom,mat);starsMesh.renderOrder=2;scene.add(starsMesh);const ds=document.getElementById("desktop-star-count"),dl=document.getElementById("desktop-location-info"),dt=document.getElementById("desktop-time-info");if(ds)ds.textContent=`Stars visible: ${visible.toLocaleString()}`;if(dl)dl.textContent=`Location: ${lat.toFixed(2)}°, ${lon.toFixed(2)}°`;if(dt)dt.textContent=`Time: ${local.format("YYYY-MM-DD HH:mm")} (${tz.replace("_"," ").split("/")[1]||tz})`;const ms=document.getElementById("mobile-star-count"),ml=document.getElementById("mobile-location-info"),mt=document.getElementById("mobile-time-info");if(ms)ms.textContent=`Stars visible: ${visible.toLocaleString()}`;if(ml)ml.textContent=`Location: ${lat.toFixed(2)}°, ${lon.toFixed(2)}°`;if(mt)mt.textContent=`Time: ${local.format("YYYY-MM-DD HH:mm")} (${tz.replace("_"," ").split("/")[1]||tz})`;btn.disabled=false},10)}
function createStarTexture(glow){const canvas=document.createElement("canvas"),size=256;canvas.width=size;canvas.height=size;const ctx=canvas.getContext("2d"),c=size/2,g=ctx.createRadialGradient(c,c,0,c,c,c),gi=Math.max(.3,glow);g.addColorStop(0,"rgba(255,255,255,1)");g.addColorStop(.12,"rgba(255,255,255,0.9)");g.addColorStop(.32,`rgba(255,255,255,${.45*gi})`);g.addColorStop(.62,`rgba(255,255,255,${.18*gi})`);g.addColorStop(1,"rgba(255,255,255,0)");ctx.fillStyle=g;ctx.fillRect(0,0,size,size);return new THREE.CanvasTexture(canvas)}
function updateVisualSetting(s,v){currentSettings[s]=sliderToActual(v,s);if(starsMesh){if(s==="brightness"&&starsMesh.material.uniforms.brightness){starsMesh.material.uniforms.brightness.value=currentSettings.brightness}else{createStarField()}}}
function updateSkyAndURL(){updateSky();updateURL()}
function updateSky(){currentSettings.magCutoff=sliderToActual(document.getElementById("mag-cutoff").value,"magCutoff");currentSettings.starScale=sliderToActual(document.getElementById("star-scale").value,"starScale");currentSettings.brightness=sliderToActual(document.getElementById("brightness").value,"brightness");currentSettings.glowIntensity=sliderToActual(document.getElementById("glow-intensity").value,"glowIntensity");currentSettings.colorTemp=sliderToActual(document.getElementById("color-temp").value,"colorTemp");createStarField()}
function updateURL(){const p=new URLSearchParams;p.set("lat",document.getElementById("latitude").value);p.set("lon",document.getElementById("longitude").value);p.set("date",document.getElementById("date-input").value);p.set("time",document.getElementById("time-input").value);p.set("tz",document.getElementById("timezone-select").value);p.set("mag",document.getElementById("mag-cutoff").value);p.set("scale",document.getElementById("star-scale").value);p.set("bright",document.getElementById("brightness").value);p.set("glow",document.getElementById("glow-intensity").value);p.set("temp",document.getElementById("color-temp").value);p.set("twinkle",currentSettings.twinkle?"1":"0");p.set("compass",currentSettings.showCompass?"1":"0");window.history.replaceState({},"",window.location.pathname+"?"+p.toString())}
function loadFromURL(){const p=new URLSearchParams(window.location.search);if(p.size===0)return false;if(p.has("lat"))document.getElementById("latitude").value=p.get("lat");if(p.has("lon"))document.getElementById("longitude").value=p.get("lon");if(p.has("date"))document.getElementById("date-input").value=p.get("date");if(p.has("time"))document.getElementById("time-input").value=p.get("time");if(p.has("tz"))document.getElementById("timezone-select").value=p.get("tz");if(p.has("mag"))updateSliderFromURL("mag-cutoff",p.get("mag"));if(p.has("scale"))updateSliderFromURL("star-scale",p.get("scale"));if(p.has("bright"))updateSliderFromURL("brightness",p.get("bright"));if(p.has("glow"))updateSliderFromURL("glow-intensity",p.get("glow"));if(p.has("temp"))updateSliderFromURL("color-temp",p.get("temp"));if(p.has("twinkle")){currentSettings.twinkle=p.get("twinkle")==="1";document.getElementById("twinkle-toggle").classList.toggle("active",currentSettings.twinkle)}if(p.has("compass")){currentSettings.showCompass=p.get("compass")==="1";document.getElementById("compass-toggle").classList.toggle("active",currentSettings.showCompass)}return true}
function updateSliderFromURL(id,val){const s=document.getElementById(id);if(s){s.value=val;s.dispatchEvent(new Event("input"))}}
function togglePanel(){const panel=document.getElementById("control-panel"),info=document.getElementById("info-display");panel.classList.toggle("collapsed");info.classList.toggle("collapsed")}
function toggleMobilePanel(){if(window.innerWidth<=768){const panel=document.getElementById("control-panel");panel.classList.toggle("mobile-collapsed");document.body.classList.toggle("mobile-panel-collapsed")}}
function toggleTwinkle(){const t=document.getElementById("twinkle-toggle");t.classList.toggle("active");currentSettings.twinkle=t.classList.contains("active");if(starsMesh){starsMesh.material.uniforms.twinkleEnabled.value=currentSettings.twinkle?1:0}}
function toggleCompass(){const t=document.getElementById("compass-toggle");t.classList.toggle("active");currentSettings.showCompass=t.classList.contains("active");document.getElementById("compass-container").style.opacity=currentSettings.showCompass?"1":"0"}
function takeScreenshot(){const panel=document.getElementById("control-panel"),info=document.getElementById("info-display"),compass=document.getElementById("compass-container"),pd=panel.style.display,id=info.style.display,cd=compass.style.display;panel.style.display="none";info.style.display="none";compass.style.display="none";renderer.render(scene,camera);const img=renderer.domElement.toDataURL("image/jpeg");panel.style.display=pd;info.style.display=id;compass.style.display=cd;const a=document.createElement("a");a.href=img;a.download="astro-map-screenshot.jpg";a.click()}
function animate(){requestAnimationFrame(animate);animationTime+=.008;if(starsMesh&&starsMesh.material.uniforms.time)starsMesh.material.uniforms.time.value=animationTime;if(sunGlowMesh&&sunGlowMesh.material.uniforms.time)sunGlowMesh.material.uniforms.time.value=animationTime;if(earthMesh&&earthMesh.material.uniforms.time)earthMesh.material.uniforms.time.value=animationTime;controls.update();updateCompass();renderer.render(scene,camera)}
window.addEventListener("resize",()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)});
window.addEventListener("load",()=>{const hasParams=loadFromURL();if(!hasParams){const now=moment();document.getElementById("date-input").value=now.format("YYYY-MM-DD");document.getElementById("time-input").value=now.format("HH:mm")}if(typeof hipparcos_catalog==="undefined"||typeof Astronomy==="undefined"){document.getElementById("loading").innerHTML='<div class="loading-spinner"></div>Error: Could not load celestial libraries';return}if(window.innerWidth<=768){document.body.classList.remove("mobile-panel-collapsed")}initScene();updateSky();animate()});
</script>
</body>
</html>
